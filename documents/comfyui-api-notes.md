- test.ipynb 用来验证 ComfyUI “HTTP 提交 + WebSocket 监听完成 + HTTP 拉取结果”的官方推荐调用链路：POST /prompt → GET /ws → GET /history/{prompt_id} → GET /view` 下载图片。
- 环境与参数通过环境变量可覆盖：
  - COMFYUI_BASE_URL（默认 http://127.0.0.1:8188，会 rstrip("/")）
  - COMFYUI_WORKFLOW_JSON（默认 CKNOOBRF.json）
  - COMFYUI_OUT_DIR（默认 comfyui_api_outputs，自动创建）
  - COMFYUI_CLIENT_ID（默认随机 uuid4）
  - COMFYUI_REQUEST_TIMEOUT_S（HTTP/WS 读超时，默认 30s）
  - COMFYUI_JOB_TIMEOUT_S（整体任务等待超时，默认 600s）
- 工作流加载方式：直接读取导出的 workflow JSON（字典结构，key 是节点 id 字符串），后续“原样”作为 prompt 字段提交到 /prompt。
- 提供“尽力而为”的工作流参数覆盖 patch_workflow_inplace()（按特定导出文件 CKNOOBRF.json 的节点结构硬编码）：
  - 正向提示词：节点 13 的 inputs.positive
  - 负向提示词：节点 4 的 inputs.text
  - 采样器：节点 6 的 inputs.seed/steps/cfg
  - 分辨率：节点 5 的 inputs.width/height
  - 缺节点/缺字段会 WARN 并跳过；seed 默认用 random.randint(...) 生成，其它参数默认不改（None）。
- HTTP API 封装细节：
  - comfy_submit_prompt()：POST {BASE_URL}/prompt，payload 为 {"prompt": workflow, "client_id": CLIENT_ID}；兼容返回字段 prompt_id 或 promptId。
  - comfy_get_history_item()：GET /history/{prompt_id}；兼容两种响应形态：{prompt_id: {...}} 或 {...}。
  - comfy_collect_output_images()：从 history_item["outputs"][node]["images"] 聚合图片元数据（要求是 dict 且包含 filename）。
  - comfy_download_image()：GET /view?filename=...&subfolder=...&type=...，直接把二进制写入本地文件。
- WebSocket 完成态监听（依赖 websocket-client）：
  - comfy_ws_connect()：把 BASE_URL 从 http(s) 转成 ws(s)，连接 /{base_path}/ws?clientId=...（query 参数名为 clientId，值做 URL encode）。
  - comfy_ws_wait_prompt_done()：循环 ws.recv() 直到超时；忽略二进制预览帧（非字符串）与非 JSON；完成判定兼容两种消息：
    - type == "executing" 且 data.prompt_id == prompt_id 且 data.node is None
    - 或 type == "execution_success" 且 data.prompt_id == prompt_id
  - ws.settimeout(REQUEST_TIMEOUT_S)，超时抛 WebSocketTimeoutException 时继续轮询，整体由 JOB_TIMEOUT_S 控制。
- 主流程顺序刻意是“先连 WS 再提交任务”，避免错过完成消息；无论成功失败都会在 finally 里关闭 WS。
- 结果落盘：取第一张图的 filename 后缀作为扩展名，保存为 OUT_DIR/{prompt_id}{ext}；并尝试用 PIL + IPython.display 在 notebook 内联展示（失败则跳过）。
- 依赖：requests（HTTP）、websocket-client（WS）、可选 Pillow（展示）。